/*! ablejs - v0.2.0 - Thursday, April 14th, 2016, 5:56:52 PM
* http://www.ablesky.com
* Copyright (c) 2016 frontend@ablesky.com; Licensed  */
define(["module","jquery","common/global","lib/jquery/jquery.dialog","courseview/view-exam-audio","utils/mathjax"],function(e,t,a,i,n,r){"use strict";function c(e){if(!e)return"";for(var t=e.split(","),a=t.length,i=0;a>i;i++)t[i]=String.fromCharCode(65+parseInt(t[i]));return t.join()}function o(e,t,a,i,n,r){var o=a.options,s=a.answer,l=a.userAnswer,e=a.typeId;a.optionName=t;for(var d,u,p,m,h,v,f,k=o.length,g=['<div class="item ',r,'" style="overflow:hidden;">'],x=2===e?"checkbox":"radio",b="",y=i?'disabled="disabled"':"",I=0;k>I;I++)v=I.toString(),m=s.indexOf(v)>-1,h=l.indexOf(v)>-1,f=[],p=h?'checked="checked"':"",i&&(1===e||3===e?b=m?"true":h?"err":"":2===e&&(m?b="true":h||m?h&&!m&&(b="err"):b="")),d=c(I.toString()),u=o[I].content,f.push('<div class="option">'),f=f.concat(['<p class="asr-btn ',b,'">','<label><input data-num="'+n+'" ',p,y,' type="',x,'" value="',I,'" name="',t,'" />',d,"：</label></p>"]),f=f.concat(['<div class="asr-body ',b,'">',u,"</div>"]),f.push("</div>"),g.push(f.join(""));return g.push("</div>"),g.join("")}function s(e,t,a){if(e){var i="v_exam_"+parseInt((new Date).getTime()*Math.random()),n=parseInt(e.typeId),r=["<dt>问题",t+1,"：</dt>"],s=['<dd><div class="topic item content">',e.content,"</div>",'<div class="item J_examAudio" data-url="'+e.audioUrlForPlay+'"></div>',o(n,i,e,a,t,a?"":j)];a&&(s.push('<p class="item"><b>正确答案：'+c(e.answer)+"</b></p>"),e.analysis&&(s.push("<p><b>答案解析：</b></p>"),s.push('<div class="asr-exp item content">'+e.analysis+"</div>"))),s.push("</dd>");var l=['<dl class="u-v-exam">',r.join(""),s.join(""),"</dl>"];return!a&&J&&l.push('<a href="javascript:;" class="quit-exam" id="J_quitExam">跳过</a>'),a||J||l.push('<div style="color:#F02A2A;display:none;" id="J_examInfo">请先选择答案!</div>'),l.join("")}}function l(e){var a=[];return t("input[data-num="+e+"]","."+j).each(function(e,t){t.checked&&a.push(t.value)}),I[e].userAnswer=a.join(),J?(t("#J_examInfo").hide(),!0):a.length>0?(t("#J_examInfo").hide(),!0):(t("#J_examInfo").show(),!1)}function d(){var e=document.getElementById(T);e&&e.playInterface&&e.playInterface()}function u(){var e=l(w);e&&(C-1>w&&w++,k())}function p(){l(w),w>0&&w--,k()}function m(){v()}function h(){var e=l(w);e&&k(!0)}function v(){return _&&_.close(),I={},w=0,C=0,y=!1,b.length>0?(g(),void 0):(d(),void 0)}function f(e){if(!e.success)return!1;for(var t,a,i=e.result.list,n=i.length,r=[],c=0;n>c;c++)t={},t.id=i[c].id,t.typeId=i[c].type.id,t.typeName=i[c].type.name,t.content=i[c].content,t.audioUrlForPlay=i[c].audioUrlForPlay||"",t.analysis=i[c].analysis||"",a=i[c].answerSlotList.list[0],t.answer=a.objectiveAnswer,t.userAnswer="",t.optionName="",t.options=a.optionList.list,r.push(t);return r}function k(e){_&&_.close();var a={title:"小测验",width:560,modal:!0,content:function(e){var t="";if(e){t='<div class="m-v-total">';for(var a=0;C>a;a++)t+=s(I[a],a,!0)}else t='<div class="m-v-only">',t+=s(I[w],w);return t+="</div>"}(e),buttons:function(e){return e?[A.close]:1===C?[A.total]:0===w?[A.next]:w>0&&C-1>w?[A.prev,A.next]:w===C-1?[A.prev,A.total]:void 0}(e)};_=t.dialog(a),t("#J_quitExam").click(m),e?t(".dialog-close",_.dr).click(function(){v()}):t(".dialog-close",_.dr).hide(),t("img",_.dc).hide().load(function(){var e=this;setTimeout(function(){t(e).show(),_.setCenterPosition()},200)}),t(".J_examAudio").each(function(e,t){var a=t.getAttribute("data-url");a&&t.appendChild(n.createPlayer(a,""))}),r.render()}function g(e,i){var n;if(e){if(y)return b.push({tid:e,time:i}),void 0;y=!0}else{if(y)return;b.length>0&&(n=b.shift(),e=n.tid,i=n.time,y=!0)}_=t.dialog({title:"小测验",width:500,modal:!0,content:'<p style="text-align:center">正在读取测验试题...</p>',buttons:function(e){return e?[A.skip]:[]}(J)}),t(".dialog-close",_.dr).hide();var r="exam/examPaper.do?action=findQuestionsWithOutAuth";"www.ablesky-a.com"===location.hostname&&(r="as-examsystem/examPaper.do?action=findQuestionsWithOutAuth");var c={testId:e},o=a.queryString("snapshotInfoId");o&&(c.type="sc"),t.get(r,c,function(e){return I=f(e),I===!1?(y=!1,v(),void 0):(C=I.length,k(),void 0)},"json")}function x(e,t){AUIPlayer.veiwExamStart=g,T=e+"_api",J=t}var b=[],y=!1,I={},w=0,C=0,_=null,j="J_options",T="",J=!0,A={total:{text:"提交",css:{backgroundColor:"#09f"},click:h},prev:{text:"上一题",id:"kkk",css:{backgroundColor:"#09f"},click:p},next:{text:"下一题",css:{backgroundColor:"#09f"},click:u},close:{text:"关闭",css:{backgroundColor:"#09f"},click:v},skip:{text:"跳过",css:{backgroundColor:"#09f"},click:m}};return{init:x}});