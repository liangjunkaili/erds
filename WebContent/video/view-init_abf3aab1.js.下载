/*! ablejs - v0.2.0 - Friday, December 9th, 2016, 6:24:55 PM
* http://www.ablesky.com
* Copyright (c) 2016 frontend@ablesky.com; Licensed  */
define(["module","jquery","common/global","courseview/video-util","courseview/view-toolbar","common/base64","courseview/view-exam"],function(e,t,o,n,a,i,s){"use strict";var r=e.config(),c=document.title;console.log(c);var l=!1;t(function(){function e(){A.on({click:function(){var e=t(this);"337px"==B.css("right")?(B.animate({right:0}),x.animate({width:0}),e.attr("title","显示课程目录"),e.html("<<")):"0px"==B.css("right")&&(B.animate({right:"337px"}),x.animate({width:"335px"}),e.html(">>"))}}),t(".CB-switch-network",B).on({click:function(){var e=t(this),n=e.data("switchNetwork"),a=window.location.hash;a=a?a.split("=")[1]:"","findBestAuto"===n?window.open("testRedirect.do?action=toPage&page=speedVideo&courseId="+q+"&id="+a+"&snapshotInfoId="+o.queryString("snapshotInfoId")+"&ref="+encodeURIComponent(window.location.href)):/&idc=/.test(window.location.search)?(console.log(window.location.search),window.location.search=window.location.search.replace(/&idc=([^&]+)/g,"&idc="+n)):window.location.search+="&idc="+n}}),t("#J_accelerateTip"),P.bind({click:function(){var e=document.getElementById("J_ableskyFlashDiv_api");e.pauseInterface&&e.pauseInterface(),t("#pc_download").show()}}),t("#download_pc_client").click(function(){t("#pc_download").show()})}function i(){var e={};e.prevVideo=a.prev,e.nextVideo=a.next,e.bestNetListSel=function(e){t("[data-switch-network="+e+"].CB-switch-network",B).parent().addClass("CB-control-tips-li-sel").siblings().removeClass("CB-control-tips-li-sel")},e.courseId=q,e.snapshotInfoId=o.queryString("snapshotInfoId"),n.initVideoAPI(e)}function d(e){function o(e){this.id=e.id,this.username=e.username,this.screenName=e.screenName,this.accountPhotoUrl=e.accountPhotoUrl,this.html=['<a class="CB-BA-SSU-users-one" target="_blank" href="'+HTTP_SERVER+this.username+'">','<img class="CB-BA-SSU-users-photo" src="'+this.accountPhotoUrl+'">','<span class="CB-BA-SSU-users-name">'+this.screenName+"</span>","</a>"].join("")}function n(e){var t;return"object"==typeof e&&(t=new o(e)),t}function a(){i.animate({top:"-37px"},function(){t(".CB-BA-SSU-users",i).eq(0).remove().appendTo(i),i.css({top:0})}),setTimeout(a,3e4)}o.prototype.pushIntoPage=function(e){this.html&&e.append(this.html)},e.length>0&&t(".CB-BA-SSU-playing").show();for(var i=t(".CB-BA-SSU-container",B),s=0,r=e.length;r>s;s+=2){var c=t('<div class="CB-BA-SSU-users clearfix"></div>').appendTo(i);n(e[s]).pushIntoPage(c),e[s+1]&&n(e[s+1]).pushIntoPage(c)}setTimeout(a,3e4)}function u(e){t.ajax({url:"course.do?action=getDynamicViewCourse",data:{isCourse:"sc"==V?!1:!0,id:e?e:u.courseId},dataType:"json",success:function(e){var t=e.result&&e.result.list;t&&d(t)}}),setTimeout(u,18e5)}function m(e){var t=e.courseAuthorityFlag,a=e.bitRate,i=e.length,s=e.timesLimit,c=e.timesLeft,l=e.lastPlayTime,d=e.lastPlayPage,u=AUI.curUserInfo.isSuperOrganizationManager||AUI.curUserInfo.isDescendantUserWithAuth,m=r.grouponid,p=null!=m?m:0,h=e.courseInfo.id,f=e.courseInfo.coursecontentType,v={id:E,width:"100%",height:"100%",length:i,timesLimit:s,timesLeft:c,lastPlayTime:l,lastPlayPage:d,visitorType:L,courseAuthorityFlag:t,isOrg:u,pcid:r.courseId?r.courseId:r.snapshotInfoId,playCourseId:h,mediaServerRoot:j,serverType:R,bitRate:a,grouponid:p,type:V,isOutside:!(/viewer.do/.test(U)||/mineOptionalCourse.do/.test(U)),orginalIdc:M,isAbleskyDomain:z};if("threewin"!=f)"done"==e.convertStatus&&(1==e.convertType?(v.isAudio=!1,v.path="1--"+e.id+"--abs.flv",v.isUpload=!0,v.autoPlay=!0,v.useCanvas=!0,v.channelId=1,v.isUpload=!0):2==e.convertType?(v.document=!0,v.path=e.id,v.autoPlay=!1,v.isUpload=!1,v.channelId=1,v.isNew=r.isNew||"on"):3==e.convertType?(v.path="1--"+e.id+"--abs.flv",v.isUpload=!0,v.autoPlay=!0,v.useCanvas=!0):4==e.convertType&&(v.swf=!0,v.path="1--"+e.id+"--abs.flv",v.isUpload=!1,v.autoPlay=!1,v.useCanvas=!0,v.channelId=1));else{var y=e.courseInfo?e.courseInfo:{},w=y.documentDataId,I=y.volumeId,g=y.threewinType,b=!1,C=r.playCourseIsAgency;"owner"==L&&"false"==C&&(b=!0),"doubleVideo"==g?(v.url="1--"+e.id+"--abs.flv",v.mutilpVideo=!0,v.isUpload=!0,v.autoPlay=!1,v.useCanvas=!0,v.channelId=1,v.baseUrl=BASE_PATH,v.documentDataId=w,v.volumeId=I,v.isAdmin=b,v.preview="true"==o.queryString("preview")):(v.threeWins=!0,v.autoPlay=!1,v.isUpload=!0,v.preview="true"==o.queryString("preview"),v.pageLocation=U.split("?")[0],v.serverRoot=BASE_PATH,v.dataId=y.dataId,v.documentDataId=w,v.editModel=!1,v.volumeId="",v.courseId=y.id,v.isAdmin=b)}e.chargeType&&(H=e.chargeType),v.autoPlay=2==H?!1:!0,n.flowPlayer(v)}function p(e){t("#pc_download").hide();var o=t("#"+E),n=e.courseInfo.id,a=e.courseInfo.courseId;o.children().length>0?o.animate({opacity:.25},200,function(){o.html(""),o.animate({opacity:1}),m(e)}):m(e),P.data("securePlayerConfig",{id:e.id,playCourseId:n,convertType:e.convertType,coursecontentType:e.courseInfo.coursecontentType,threewinType:e.courseInfo.threewinType}),t("#run_client").data("courseConfig",{id:e.id,playCourseId:n,convertType:e.convertType,coursecontentType:e.courseInfo.coursecontentType,threewinType:e.courseInfo.threewinType}),"doubleVideo"==e.courseInfo.threewinType||"threewin"!=e.courseInfo.coursecontentType&&4==e.convertType?(t(".CB-control-tips-ableplayer").hide(),t(".CB-control-tips-secureplayer").show()):(t(".CB-control-tips-ableplayer").show(),t(".CB-control-tips-secureplayer").hide()),D&&!F&&function(e){var t="(^|,)"+e+"(,|$)";new RegExp(t).test(N)?(S.removeClass("CB-BA-view-attachment-unavailable").addClass("CB-BA-view-attachment-normal"),S.attr("href",HTTP_SERVER+"kecheng/detail_"+q+"#"+n)):O?(S.removeClass("CB-BA-view-attachment-unavailable").addClass("CB-BA-view-attachment-normal"),S.attr("href",HTTP_SERVER+"kecheng/detail_"+q+"#total")):S.addClass("CB-BA-view-attachment-unavailable").removeClass("CB-BA-view-attachment-normal").removeAttr("href")}(a),u.courseId&&u.courseId==n||(u(n),u.courseId=n),s.init(E,e.canSkipTest),window._bd_share_config||f(e)}function h(){return c}function f(e){var t="http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion="+~(-new Date/36e5),o=location.protocol+"//"+location.host+"/kecheng/detail_"+q,n=h(e);window._bd_share_config={common:{bdUrl:o,bdSnsKey:{},bdText:n,bdMini:"2",bdMiniList:["weixin","tsina","qzone","mshare","bdysc","tqq","sqq","bdxc","tqf","tieba","douban","bdhome","thx","youdao","mail","yaolan","wealink","ty","fbook","twi","linkedin","evernotecn","copy","print"],bdPic:"",bdStyle:"2",bdSize:"16",bdPopupOffsetTop:0,bdPopupOffsetLeft:-120},share:{},selectShare:{bdContainerClass:null,bdSelectMiniList:["weixin","tsina","qzone"]}},document.getElementById("bdshare_script").src=t}function v(e){W()&&e.hide(),e.addClass("move"),setTimeout(function(){e.hide(),e.removeClass("move")},1e3)}function y(e,o){t.get(e,{id:o},function(){},"json")}function w(){var e=t("#fav_btn").attr("data-s");l="true"===e?!0:!1,t("#fav_btn").click(function(){var e=q;l?(y("/changeFavorite.do?action=deleteCourseFromFavourite",e),t("i",this).removeClass("fav-on").addClass("fav-off"),t("span",this).text("收藏"),l=!1):(y("/changeFavorite.do?action=addCourseToFavourite",e),t("i",this).removeClass("fav-off").addClass("fav-on"),t("span",this).text("已收藏"),l=!0)})}function I(){Q.star=0,Q.text=""}function g(){D&&(G=window.location.hash.substring(16).split("_")[1]);var e={organizationId:J,courseId:G,type:V,score:Q.star,content:Q.text};"sc"==V?e.courseContentSnapshotId=X:e.courseContentId=X,D&&(e.courseType="package"),t.post("/ajax/course/feedback/save",e,function(e){e.success?b(!0):alert(e.message)},"json"),I()}function b(e){e?(t("#comment_mod").addClass("disable"),t("#comment span").text("已评"),t("#comment").attr("data-s","0")):(t("#comment_mod").removeClass("disable"),t("#comment span").text("评价"),t("#comment").attr("data-s","1"))}function C(e,o){D&&(G=o);var n={organizationId:J,courseId:G,courseContentId:e,type:V};"sc"==V&&(n.courseContentSnapshotId=e),D&&(n.courseType="package"),t.get("/ajax/course/feedback/check",n,function(e){$=e.success,b(e.success)},"json")}function T(){var e='<div class="m-comment">	    			<ul id="comment_star" class="star">	    				<li data-n="0"></li><li data-n="1"></li><li data-n="2"></li><li data-n="3"></li><li data-n="4"></li>	    			</ul>	    			<div class="text-box">	    				<textarea maxlength="100" id="comment_text" class="text" placeholder="谈谈学习感受"></textarea>	    				<p id="comment_text_num" class="num">0/'+Q.maxNum+'</p>	    			</div>	    			<p id="comment_err" class="err"></p>	    		</div>';return e}function _(){function e(){var e=this.value;Q.text=e,t("#comment_text_num").text(e.length+"/"+Q.maxNum)}if(null===Y){var o=this.getAttribute("data-s");"0"!==o&&(Y=t.dialog({title:"课程给力吗？给个好评吧~",content:T(),width:450,buttons:[{text:"发布",css:{backgroundColor:"#09f"},click:function(){0===Q.star?t("#comment_err").text("请选择星级！"):""===Q.text?t("#comment_err").text("请谈谈学习感受！"):(t("#comment_err").text(""),g(),Y.close(),Y=null)}},{text:"取消",click:function(){I(),Y.close(),Y=null}}],close:function(){Y=null}}),t("#comment_star li").click(function(){var e=this.getAttribute("data-n");e=parseInt(e,10),Q.star=e+1,t("#comment_star li").each(function(t,o){o.className=e>=t?"sel":""})}),t("#comment_text").keydown(e),t("#comment_text").blur(e))}}var B=t("#J_coursePlayBox"),x=t(".course-box-toolbar-wrap"),A=t("#J_controlToolbarBtn"),P=t(".CB-BA-download-course",B),S=t(".CB-BA-view-attachment",B),k={},U=window.location.href,E="J_ableskyFlashDiv";r.ownerName,r.snapshotInfoId;var q=r.courseId,D=r.isPackageCourse,j=r.mediaServer,R=r.serverType,V=r.courseType,L=r.visitorType,N=r.attachmentCourseList,O=r.hasAttachment,F=r.isInternalCourse,M=r.idc;r.ablePlayer;var H=r.chargeType,z=r.isAbleskyDomain;AUI._addAuiEvent("loginOut",function(){n.pauseVideo()});var J=r.ownerOrgId;require(["lib/jquery/jquery.qrcode.min"],function(){var e="canvas";document.createElement("canvas").getContext||(e="table");var o=z?HTTP_SERVER+"app/qrcode/courseDetail?downloadApp=1&courseid="+r.courseId:"http://"+location.host+"/app/download/ableCourseOne?appType=netSchool&courseid="+r.courseId;t(".qrcode-img-wrap").empty().qrcode({render:e,width:125,height:125,text:o});var n=null;t(".CB-BA-mobile-course").on("mouseover",function(){clearTimeout(n);var e=t(this);n=setTimeout(function(){e.find(".course-qrcode-wrap").show()},500)}).on("mouseout",function(){clearTimeout(n);var e=t(this);n=setTimeout(function(){e.find(".course-qrcode-wrap").hide()},200)});var a=null;t(".CB-BA-view-attachment").on("mouseover",function(){clearTimeout(a);var e=t(this);a=setTimeout(function(){e.find(".no-attachment-tip").show()},500)}).on("mouseout",function(){clearTimeout(a),t(this).find(".no-attachment-tip").hide()})}),AUIPlayer.showDownloadTip=function(e){"2"!==e&&(t("#pc_download").hide(),t("#pc_download").show())},AUIPlayer.hideDownloadTip=function(){v(t("#pc_download"))},t("#pc_download_close").click(function(){var e=t(this).parent();v(e)}),t("#run_client").click(function(){var e=t(this),o=e.data("courseConfig"),n=document.getElementById("J_ableskyFlashDiv_api"),a=n&&"function"==typeof n.getCurrentPlayTimeInterface?n.getCurrentPlayTimeInterface():0;t("#ableplayer_frame")&&t("#ableplayer_frame").remove();var i=document.createElement("iframe");if(i.style.display="none",i.id="ableplayer_frame",document.body.appendChild(i),W())window.open("ableplayerp://"+BASE_PATH.substr(7)+"?courseId="+o.playCourseId+"&username="+AUI.curUserInfo.username+"&id="+o.id+"&lastTime="+a+"&lastPage=0&type="+V,"ableplayer_frame");else{var s="ableplayerp://"+BASE_PATH.substr(7)+"?courseId="+o.playCourseId+"&username="+AUI.curUserInfo.username+"&id="+o.id+"&lastTime="+a+"&lastPage=0&type="+V;t("#ableplayer_frame").attr("src",s)}});var W=function(){var e=navigator.userAgent,t=e.indexOf("MSIE")>-1,o=t?e.match(/MSIE (\d+)/)[1]:"no ie";return parseInt(o)<=10},K=!1,$=!0,G=q;"null"!==r.subId&&(G=r.subId);var Q={star:0,text:"",maxNum:100},X="",Y=null;t("#comment").click(_),k.initVideo=p,k.flashDiv=E,k.onChangeContent=function(e,o){var n=o[e];n.otherContentId?t("#comment_mod").hide():(K=!0,t("#comment_mod").show(),X=e,C(e,n.courseInfo.courseId)),I(),null!==Y&&(Y.close(),Y=null)},a.init(k),function(){var e=!(!navigator.userAgent.match(/Trident/)||!navigator.userAgent.match(/rv:11.0/));e&&document.addEventListener&&document.addEventListener("DOMSubtreeModified",function(){document.title!==c&&setTimeout(function(){document.title=c},1)})}(),e(),i(),w(),n.playerCallback.onend=function(){K&&!$&&_.call(document.getElementById("comment"))}})});