/*! ablejs - v0.2.0 - Friday, December 23rd, 2016, 11:18:28 AM
* http://www.ablesky.com
* Copyright (c) 2016 frontend@ablesky.com; Licensed  */
define(["module","jquery"],function(t,e){"use strict";function s(t){e.extend(W,t),Y=W.isSeries,Q=Y||W.isPresell,te=W.courseType,Z=W.courseId,ee=W.courseId,ie=W.ownerName,se=W.snapshotInfoId,ne=W.initVideo,i(),a(),n(),P.find(".course").click()}function i(){P.click(l),e(".cvtb-MCK-series-title",F).live("click",u),e(".cvtb-MCK-hour-item",F).live("click",h),document.attachEvent&&document.attachEvent("onpropertychange",function(t){"title"===t.propertyName&&document.title!==z&&setTimeout(function(){document.title=z},1)}),e("#ctvbFav").hover(function(){var t=e("#cvtbMainContent").height();console.log(1),e("#scrollBox").css({height:t+"px"})},function(){e("#scrollBox").css("height",0)})}function n(){function t(t){for(var e=[],s=0;s<t.length;s++){var i="/kecheng/detail_"+t[s].id+"?source="+t[s].source;t[s].isAbleksyDomain&&(i=G+i);var n=t[s].initStudyTimes>99999?"99999+":t[s].initStudyTimes,a=['<li class="clearfix">','<div class="list-cover">','<a href="'+i+'" title="'+t[s].fullTitle+'" target="_blank">','<img src="'+t[s].coursePhotoUrl+'">',"</a>","</div>",'<div class="list-content">','<p><a href="'+i+'" title="'+t[s].fullTitle+'" target="_blank">'+t[s].title+"</a></p>",'<div class="study-num">',n,"</div>","</div>","</li>"];e.push(a.join(""))}return e.join("")}if(console.log(te),"course"==te){var s=e("#scrollBox ul");s.hasClass("no-more")||e.ajax({url:"/ajax/course/recommend",data:{source:"guest_you_like",courseId:W.courseId,start:0,limit:30},dataType:"json",success:function(i){if(i.success){var n=i.CourseRecommendDtoList.list;if(n.length>0){e("#ctvbFav").removeClass("hidden"),e("#cvtbMain").addClass("has-data");var a=t(n);""!==a&&(s=e("#scrollBox ul").html(a))}}}})}}function a(){var t=window.location.hash,e=t.substring(16);!t||-1==t.indexOf("#currentPlaying=")||!Q&&!/^\d+$/.test(e)||Q&&!/^\d+_\d+$/.test(e)?Q&&o():c(e)}function o(){X.series=B.find(".j-series-0")}function c(t){if(Q){var e=t.split("_"),s=B.find("#"+oe+e[1]);s.length?(X.series=s,X.contentId=e[0]):o()}else X.contentId=t}function l(t){var s=e(t.target);s.is(".current")||(s.addClass("current").siblings().removeClass("current"),r(s),d(s.siblings()))}function r(t){var s=e(t),i=s.data("content");e(i,R).show(),s.is(".course")?J||(b(),J=!0):s.is(".note")?require(["courseview/view-toolbar-note"],function(t){t.select(W,V)}):s.is(".ask")&&require(["courseview/view-toolbar-ask"],function(t){t.select(W)})}function d(t){for(var s,i=t.length;i--;)s=e(t[i]).data("content"),e(s,R).hide()}function u(){var t=e(this),s=t.parent(),i=t.siblings("ul.cvtb-MCK-course-list"),n=t.siblings(".cvtb-nodata"),a=i.length,o=t.data("contentLoaded"),c=s.data("coursetitle"),l=s.data("issubadminnoauth");if(re&&re.close(),l){var r='您的帐号未开通课程"'+c+'"，无法观看。您可以在网校后台--学员管理功能下开通该课程';return j(r),void 0}O=s,t.hasClass("open")?(t.removeClass("open"),a&&i.hide(),!a&&n.hide()):(o||(m(s,s.data("id")),t.data("contentLoaded",!0),i=t.siblings("ul.cvtb-MCK-course-list"),a=i.length),t.addClass("open"),a&&i.show(),!a&&n.show())}function v(t,s,i){var n={id:i};if(se&&(n.type="sc"),5===s||6===s)var a=window.open("about:blank");e.ajax({url:"ajax/course/study/studyCourseContentOfTextOrLink",data:n,dataType:"json"}).done(function(i){if(i&&i.success){if(9===s)var n=['<div style="text-align:left;">','<p style="text-align:center;"><span>'+t.data("seqtitle")+'</span>：<span  class="subjectTitle">'+t.attr("title")+"</span></p>",'<div class="taskDesc" style="max-height:300px;overflow-y:auto;">'+i.taskDesc+"</div>","</div>"].join(""),o=e.dialog({boxid:"#commonShowDialog",title:"自由任务",headStyle:{backgroundColor:"#09F"},content:n,width:550,buttons:[{text:"确定",click:function(){o.close()}}]});if(5===s||6===s){var c=/^(http|https:\/\/)/gi,l=i.url;c.test(l)||(l="http://"+l),a.location.href=l,a.focus()}i.done&&t.find(".cvtb-view-status").addClass("done")}else(5===s||6===s)&&a.close()})}function h(){re&&re.close();var t=e(this),s=t.data("id"),i=Number(t.data("lessontype")),n="",a="",o=!0,c=t.closest(".j-series");if(!t.hasClass("current")){var l="";Q&&(n=t.parents(".j-series"));for(var r=0,d=ae.length;d>r;r++){var u=ae[r];if(s===u.id){var h=le?c.data("id"):se?se:Z;l=u,l.chargeType=u.chargeType,l.courseInfo={id:h,coursecontentType:u.threewinType?"threewin":null,courseId:Q?n.data("course-id"):Z},u.threewinType&&(l.courseInfo.dataId=u.dataId,l.courseInfo.documentDataId=u.documentId,l.courseInfo.volumeId=u.volumeId,l.courseInfo.threewinType=u.threewinType);break}}var b="currentPlaying="+l.id;Q?(a=n.data("id"),b=b+"_"+a,n.is(O)||(O=n,D.html(C(n.data("coursetitle"),n.data("photourl")))),S(a)):S(se||Z),W.onChangeContent(l.id,ue),H=t,V=l,window.location.hash=b,e.when(de).then(function(){var n={id:s};se&&(n.type="sc"),e.ajax({url:"ajax/course/study/checkStudyRestrict",data:n,async:!1,dataType:"json"}).done(function(e){if(e&&e.success===!1)if(e.isStudyInOrderNeed)o=!1,j(e.message);else if(e.notStart){var n='<div style="padding:10px 0; text-align:center;"><p>学习周期未开始</p><p style="margin-top:5px;">（学习有效期'+e.deadLineStart+"至"+e.deadLineEnd+"）</p></div>";j(n)}else if(e.hasExpired){var n='<div style="padding:10px 0; text-align:center;"><p>学习周期已过期</p><p style="margin-top:5px;">（学习有效期'+e.deadLineStart+"至"+e.deadLineEnd+"）,请联系网校老师或立即续购课程!</p></div>";p({msg:n})}else{var n='<div style="padding:10px 0; text-align:center;"><p>该课程已过期</p><p style="margin-top:5px;">（学习有效期'+e.deadLineStart+"至"+e.deadLineEnd+"）</p></div>";p({msg:n})}else 9===i||5===i||6===i?v(t,i,s):7===i||8===i?f(a,s):ne(l)})}),o&&(e(".cvtb-MCK-hour-item",F).removeClass("current"),t.addClass("current"))}}function p(t){var s=e.dialog({boxid:"#J_study",title:"温馨提示",headStyle:{backgroundColor:"#09F"},modal:!0,content:'<div class="tipCnt">'+t.msg+"</div>",width:t.width?t.width:340,buttons:[{text:"立即续购",css:{backgroundColor:"#09f"},click:function(){var t=BASE_PATH;t=t.replace(/^http:\/\//,""),t=t.replace(/\/$/,""),window.location.href=HTTP_SERVER+"paymentRedirect.do?action=paymentDomainRedirect&host="+t+"&grouponid=0&type=course&id="+ee}},{text:"关闭",click:function(){s.close()}}]})}function f(t,s){var i="",n=t?t:se,a=t?t:Z,o=se?se:Z;Y&&(i="&gcid="+o);var c=se?["mineOptionalCourse.do?action=viewCourseContent&snapshotInfoId=",n,i,"&type=sc&isTest=true&id=",s].join(""):["viewer.do?courseId=",a,i,"&isTest=true&id=",s].join(""),l=window.open("about:blank"),r="";se&&(r="sc",Z=se),e.ajax({url:"myExamAndTest.do?action=getMyTest",data:{coursecontentId:s,courseId:Z,type:r},dataType:"json",type:"get",success:function(t){t.isOwner===!0?(l.location.href=EXAM_SERVER+"examPaperRedirect.do?action=toEditExamPaperOne&isEditOrShow=SHOW&ep_id="+t.result.id+"&subjectId="+t.result.subjectId,l.focus()):1!=t.isFinished||t.isExercise?(l.location.href=c,l.focus()):(l.location.href=EXAM_SERVER+"studentCenterRedirect.do?action=toExamResult&examRecordId="+t.examId+"&isCorrect=true&courseId="+Z,l.focus())}})}function b(){Q?e(".cvtb-MCK-series-title",X.series).click():m(F)}function m(t,s){var i,n=s||(se?se:Z),a=e('<div class="cvtb-loading">数据加载中...</div>'),o={courseId:n};se&&(o.type="sc"),a.appendTo(t).show(),e.get("course.do?action=getCourseContentList",o,function(n){if(a.remove(),!n.result&&!n.success)return e('<div class="cvtb-nodata">额，出错了，课件出不来了！</div>').appendTo(t).show(),void 0;var o,c,l,r=n.result.list,d=r.length,u=null,v=Q?"":" cvtb-scroll-y cvtb-absolute";if(d){o=e('<ul class="cvtb-MCK-course-list'+v+'">');for(var h=d;h--;)u=r[h],l=x(u,1==d,d>1&&0==h,d>1&&h==d-1,s),c=e(l),o.prepend(c),0==h&&(i=c);if(o.appendTo(t).show(),g(t),!$){var p=o.find("#"+ce+X.contentId);p.length?p.click():i.find(".cvtb-MCK-hour-item").first().click(),Q?D.html(C(O.data("coursetitle"),O.data("photourl"))):D.html(C(W.courseTitle,W.photoUrl)),$=!0}}else e('<div class="cvtb-nodata">暂无课件</div>').appendTo(t).show();de.resolve().promise()},"json")}function g(t){e(".cvtb-toggle",t).toggle(function(){var t=e(this),s=t.parent().next(".cvtb-MCK-content-wrap");s.animate({height:"toggle",opacity:"toggle"},"slow"),t.hasClass("hide")?t.removeClass("hide"):t.addClass("hide")},function(){var t=e(this),s=t.parent().next(".cvtb-MCK-content-wrap");s.animate({height:"toggle",opacity:"toggle"},"slow"),t.hasClass("hide")?t.removeClass("hide"):t.addClass("hide")}),e(".cvtb-attachment").on("click",function(t){t.stopPropagation()})}function C(t,e){var s=AUI.curUserInfo.isInternal,i='<img class="cvtb-top-img" alt="课程预览图" src="'+e+'" />',n=s?i:'<a class="link" href="kecheng/detail_'+Z+'" target="_blank"  title="打开课程详情页">'+i+"</a>",a=s?'<li class="cvtb-top-list-itme">'+t+"</li>":'<li class="cvtb-top-list-item"><a class="cvtb-top-link cvtb-text-ellipsis" href="kecheng/detail_'+Z+'" target="_blank"  title="打开课程详情页">'+t+"</a></li>";return n+'<ul class="cvtb-floatleft">'+a+'<li class="cvtb-top-list-item">来源:<span class="cvtb-top-from cvtb-text-ellipsis" title="'+ie+'">'+ie+"</span></li>"+"</ul>"}function T(t){ue[t.id]=t}function y(t){var e=t.children,s="";if(e&&e.length>0)for(var i=0,n=e.length;n>i;i++)s+=["<li>",'<div class="cvtb-MCK-hour-item clearfix" data-seqTitle="'+e[i].seqTitle+'" data-lessonType="'+e[i].lessonType+'" data-id="',e[i].id,'" id="',ce,e[i].id,'" title="',e[i].subjectTilteFull,'">','<div class="clearfix ml">','<b class="cvtb-view-status '+(e[i].viewerStatus>0?1==e[i].viewerStatus?" progress":" done":"")+'"></b>','<b class="cvtb-MCK-ico cvtb-MCK-ico-com cvtb-MCK-ico-'+e[i].lessonType+'"></b>','<span class="cvtb-MCK-hour-seqTitle">'+(e[i].seqTitle?e[i].seqTitle:"")+'<span class="subjectTitle">'+e[i].subjectTitle+"</span>",e[i].attachmentCount>0?'<a href="'+e[i].courseContentAttachmentUrl+'" title="附件下载" class="cvtb-attachment"></a>':"","</span>","</div>","</div>","</li>"].join(""),ae.push(e[i]),T(e[i]);return s}function w(t){var e=t.children,s="";if(e&&e.length>0){for(var i=0,n=e.length;n>i;i++)(0===e[i].chapterType||e[i].lessonType>=0)&&(s+=['<div class="cvtb-MCK-hour-item" data-seqTitle="'+e[i].seqTitle+'" data-lessonType="'+e[i].lessonType+'" data-id="',e[i].id,'" id="',ce,e[i].id,'" title="',e[i].subjectTilteFull,'">','<div class="clearfix ml">','<b class="cvtb-view-status'+(e[i].viewerStatus>0?1==e[i].viewerStatus?" progress":" done":"")+'"></b>','<b class="cvtb-MCK-ico cvtb-MCK-ico-com cvtb-MCK-ico-'+e[i].lessonType+'"></b>','<span class="cvtb-MCK-hour-seqTitle ">'+(e[i].seqTitle?e[i].seqTitle:"")+'<span class="subjectTitle">'+e[i].subjectTitle+"</span>",e[i].attachmentCount>0?'<a href="'+e[i].courseContentAttachmentUrl+'" title="附件下载" class="cvtb-attachment"></a>':"","</span>","</div>","</div>"].join(""),ae.push(e[i]),T(e[i])),2===e[i].chapterType&&(s+=['<div class="cvtb-MCK-chapter-item clearfix">','<div class="cvtb-MCK-section-title"><span class="cvtb-MCK-overflow cvtb-MCK-seqTitle">'+e[i].seqTitle+'：<span class="subjectTitle" title="'+e[i].subjectTilteFull+'">'+e[i].subjectTitle+"</span></span></div>",'<ul class="cvtb-MCK-ul-item">',y(e[i]),"</ul>","</div>"].join(""));s='<div class="cvtb-MCK-content-wrap">'+s+"</div>"}return s}function x(t,e,s,i,n){var a,o=[],c="";return o.push("cvtb-MCK-course-content"),n&&o.push("cvtb-MCK-SL-course-content"),s&&o.push("first"),i&&o.push("last"),e&&o.push("only"),le&&o.push("seriesCourse"),a=o.join(" "),0===t.chapterType?(c=['<li class="',a,'">','<div class="cvtb-MCK-hour-item"  data-seqTitle="'+t.seqTitle+'" data-lessonType="'+t.lessonType+'" data-id="',t.id,'" title="',t.subjectTilteFull,'" id="',ce,t.id,'">','<div class="clearfix ml">','<b class="cvtb-view-status '+(t.viewerStatus>0?1==t.viewerStatus?" progress":" done":"")+'"></b>','<b class="cvtb-MCK-ico cvtb-MCK-ico-com cvtb-MCK-ico-'+t.lessonType+'"></b>','<span class="cvtb-MCK-hour-seqTitle cvtb-MCK-overflow">'+(t.seqTitle?t.seqTitle:"")+'<span class="subjectTitle">'+t.subjectTitle+"</span>",t.attachmentCount>0?'<a href="'+t.courseContentAttachmentUrl+'" title="附件下载" class="cvtb-attachment"></a>':"","</span>","</div>","</div>","</li>"].join(""),ae.push(t),T(t)):c=['<li class="',a,'">','<div class="cvtb-MCK-levelTop cvtb-MCK-overflow clearfix">','<span class="cvtb-MCK-seqTitle" style="display: block;width: 94%;">'+t.seqTitle+'：<span class="subjectTitle" title="'+t.subjectTilteFull+'">'+t.subjectTitle+"</span></span>",t.children&&t.children.length>0?'<a href="javascript:;" class="cvtb-toggle"></a>':"","</div>",w(t),"</li>"].join(""),c}function j(t){re=e.dialog({boxid:"#commonShowDialog",title:"提示",headStyle:{backgroundColor:"#09F"},content:'<div style="text-align:center;">'+t+"</div>",width:480,buttons:[{text:"知道了",click:function(){re.close()}}]})}function I(){var t=!0,s=H.closest("li").prev();if(!s.length)if(Q){var i=O.prev();i.length&&e("li",i).length||(t=!1)}else t=!1;return t}function M(){var t=!0,s=H.closest("li").next();return s.length||(Q?(U=O.next(),U.length&&e("li",U).length||(t=!1)):t=!1),t}function k(){if(I()){var t=H.closest("li").prev("li");t.length||(t=e("li.last",N)),t.find(".cvtb-MCK-hour-item").click()}}function K(){if(M()){var t=H.closest("li").next("li");t.length||(t=e("li.first",U).click()),t.find(".cvtb-MCK-hour-item").click()}}function _(t){var e="/courseAttachmentDownLoad.do?action=getAllCourseAttachment&";e+=se?"snapshotInfoId="+t+"&courseType=sc":"courseId="+t,document.getElementById("donwload_allfile").href=e}function S(t){ve!==t&&(ve=t,L(t,function(s){var i=s.length;i>0?(A(t,s,i),e("#toolbar_tab").addClass("hasfile"),i>1?e("#file_down_all").addClass("show"):e("#file_down_all").removeClass("show")):e("#toolbar_tab").removeClass("hasfile")},function(){}),_(t))}function q(t){var e=t.split("."),s="",i="";return e.length>1&&(i=e.pop()),s=e.join("."),{file:s,tail:i}}function E(){var t=e("#course_file_con").height(),s=e("#file_down_all").height();document.getElementById("course_file").style.height=t-s-115+"px"}function A(t,e,s){var i="courseId="+t;se&&(i="type=sc&courseSnapshotInfoId="+t);for(var n="",a=null,o=null,c="",l="",r="",d="",u="/courseAttachmentDownLoad.do?action=downloadAttachmentsByAttachmentContentId&"+i+"&courseAttachmentContentId=",v=0;s>v;v++)a=e[v],o=q(a.filename),""===a.subjectTitle?(l=o.file,c=o.tail):(l=a.subjectTitle,c=o.tail),""!==c?(r=l+"."+c,d='<span class="tail">.<em>'+c+"</em></span>"):(r=l,d=""),n+='<li>        			<a title="'+r+'" href="'+u+a.id+'">        			<span class="name">'+l+"</span>"+d+"</a></li>";document.getElementById("course_file").innerHTML=n,setTimeout(E,500)}function L(t,s,i){var n={};se?(n.courseSnapshotInfoId=t,n.type="sc"):n.courseId=t,e.get("/ajax/course/manage/getCourseAttachmentContents",n,function(t){t.success?s(t.attachmentList.list):i(t.message)},"json")}var R=e(".course-view-toolbar"),D=R.find(".cvtb-top"),F=R.find(".cvtb-main-content-kecheng"),P=R.find(".cvtb-main-tab"),B=R.find(".cvtb-MCK-series-list"),O=null,U=null,N=null,H=null,V={},J=!1,$=!1,X={series:null,contentId:0},z=document.title.split("#")[0],W=t.config(),G=W.asDomain||"/",Q=!1,Y=!1,Z=0,te="",ee=0,se=0,ie="",ne=null,ae=[],oe="J_cvtb_series_",ce="J_cvtb_course_content_",le=W.isPresell||W.isSeries,re="",te=W.courseType,de=e.Deferred(),ue={};require(["courseChapter/component/runMediaConvert"],function(t){t.init(Z)});var ve="",he=0;return e(window).resize(function(){clearTimeout(he),he=setTimeout(E,500)}),{init:s,next:K,prev:k,hasPrev:I,hasNext:M}});